<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÇÆ„Çø„Éº„Ç≥„Éº„ÉâÂõ≥Èëë v104 - Bb7(b9,b13) Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #121212; color: #e2e8f0; }
        
        .fretboard-scroll { overflow-x: auto; overflow-y: hidden; padding-bottom: 8px; border-radius: 0 0 8px 8px; }
        .fretboard-scroll::-webkit-scrollbar { height: 10px; }
        .fretboard-scroll::-webkit-scrollbar-track { background: #2d2d2d; }
        .fretboard-scroll::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }

        .chord-card { 
            background: linear-gradient(145deg, #1e1e1e, #181818);
            border: 1px solid #333; 
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: border-color 0.2s, transform 0.2s; 
            display: flex; flex-direction: column; 
            min-height: 380px; 
        }
        .chord-card:hover { border-color: #eab308; transform: translateY(-2px); }

        .svg-text { font-family: sans-serif; font-weight: 800; pointer-events: none; text-anchor: middle; dominant-baseline: central; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .note-circle { transition: fill 0.2s; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.6)); }
        
        .note-interactive { cursor: pointer; }
        .note-interactive:hover { opacity: 0.8; }
        .note-interactive:active { transform: scale(0.95); transform-box: fill-box; transform-origin: center; }

        .mute-mark { font-family: sans-serif; font-weight: 900; text-anchor: middle; dominant-baseline: central; fill: #ef4444; }
        .fret-num { font-family: monospace; font-size: 11px; fill: #64748b; text-anchor: middle; font-weight: bold; }

        .fretboard-bg { fill: #3e2723; } 
        .fret-wire { stroke: #c0c0c0; stroke-linecap: round; }
        .string-wound { stroke: #d4a017; }
        .string-plain { stroke: #e0e0e0; }
        .inlay { fill: #fdf5e6; opacity: 0.6; }

        .bass-btn {
            font-size: 11px; font-weight: bold; padding: 6px 4px; margin: 2px;
            border-radius: 4px; border: 1px solid #444;
            background: linear-gradient(to bottom, #333, #222);
            color: #aaa; cursor: pointer; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); flex: 1; min-width: 32px;
        }
        .bass-btn:hover { background: linear-gradient(to bottom, #444, #333); color: white; border-color: #666; }
        .bass-btn.active { background: linear-gradient(to bottom, #f59e0b, #d97706); color: #fff; border-color: #fbbf24; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        
        .all-btn { min-width: 44px !important; max-width: 44px !important; flex: none !important; }
        .std-sel-btn { font-size: 13px !important; padding: 8px 20px !important; min-width: 80px !important; flex: none !important; border-color: #555 !important; }

        .play-btn {
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            color: white; border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            cursor: pointer; border: 1px solid #1e40af; margin-left: 12px; font-size: 16px;
        }
        .play-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .play-btn:active { transform: scale(0.95); box-shadow: inset 0 3px 5px rgba(0,0,0,0.3); }

        .omit-badge {
            font-size: 10px; background-color: rgba(71, 85, 105, 0.4); color: #cbd5e1;
            padding: 0px 6px;
            line-height: 1.5;
            border-radius: 4px; border: 1px solid rgba(148, 163, 184, 0.2);
            margin-left: 8px; white-space: nowrap; display: inline-block; vertical-align: middle;
        }
        .omit-badge.warning { background-color: rgba(127, 29, 29, 0.4); color: #fca5a5; border-color: rgba(239, 68, 68, 0.5); font-weight: bold; }
        .omit-badge.rootless { background-color: rgba(147, 51, 234, 0.3); color: #d8b4fe; border-color: rgba(168, 85, 247, 0.5); }

        select.tone-select { background-color: #222; color: #eee; border: 1px solid #444; font-size: 11px; padding: 4px 8px; border-radius: 6px; outline: none; cursor: pointer; }
    </style>
</head>
<body>

    <header class="bg-[#181818] sticky top-0 z-50 border-b border-[#333] shadow-xl pb-0">
        <div class="max-w-7xl mx-auto px-4 py-1">
            <div class="flex flex-row items-center justify-between gap-2 mb-1">
                <div class="flex items-center gap-2">
                    <h1 class="text-xl font-bold text-white tracking-wider flex items-center gap-1">
                        <span class="text-yellow-500 text-2xl">üé∏</span> 
                        <span class="text-gray-200">Chord Book <span class="text-[10px] font-sans font-normal text-gray-500 ml-0.5">v104</span></span>
                    </h1>
                    <div id="status-msg" class="text-[10px] text-gray-400 bg-[#2a2a2a] px-2 py-0.5 rounded border border-[#444] hidden md:block">Ready</div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-1 bg-[#222] p-1 rounded-lg border border-[#333]">
                        <span class="text-[9px] text-gray-500 font-bold uppercase ml-1 mr-0.5 hidden sm:inline">Sound</span>
                        <select id="tone-selector" class="tone-select" onchange="setGuitarTone(this.value)">
                            <option value="acoustic">Acoustic</option>
                            <option value="nylon">Classical</option>
                            <option value="clean">Elec (Clean)</option>
                            <option value="drive">Elec (Drive)</option>
                        </select>
                    </div>
                    <div class="flex items-center bg-[#222] rounded-lg p-0.5 border border-[#333] shadow-inner">
                        <button onclick="toggleDisplayMode('note')" id="btn-note" class="px-3 py-1 rounded text-[10px] font-bold transition-all bg-blue-600 text-white shadow">Èü≥Âêç</button>
                        <button onclick="toggleDisplayMode('degree')" id="btn-degree" class="px-3 py-1 rounded text-[10px] font-bold transition-all text-gray-400 hover:text-white">Â∫¶Êï∞</button>
                    </div>
                </div>
            </div>

            <div id="root-filters" class="flex overflow-x-auto gap-1 pb-1 scrollbar-hide mb-0"></div>
            <div id="type-filters" class="flex gap-1 pb-1 overflow-x-auto scrollbar-hide border-t border-[#333] pt-1"></div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <div id="chord-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-4"></div>
        <div id="no-results" class="hidden text-center py-20 text-gray-500">No chords found.</div>
    </main>

    <footer class="text-center py-8 text-xs text-gray-600 border-t border-[#333] mt-8 bg-[#181818]">
        Guitar Chord Book v104 - Bb7(b9,b13) Manual Fix
    </footer>

    <script>
        const ROOTS = [
            { name: 'C', val: 0 }, { name: 'Db', val: 1 }, { name: 'D', val: 2 },
            { name: 'Eb', val: 3 }, { name: 'E', val: 4 }, { name: 'F', val: 5 },
            { name: 'Gb', val: 6 }, { name: 'G', val: 7 }, { name: 'Ab', val: 8 },
            { name: 'A', val: 9 }, { name: 'Bb', val: 10 }, { name: 'B', val: 11 }
        ];

        const TYPES = [
            { id: 'ALL', name: 'All', suffix: '' },
            { id: '', name: 'Major', suffix: '' }, { id: 'm', name: 'Minor', suffix: 'm' }, 
            { id: '7', name: '7th', suffix: '7' }, { id: 'm7', name: 'm7', suffix: 'm7' }, { id: 'maj7', name: 'Maj7', suffix: 'maj7' },
            { id: 'sus4', name: 'sus4', suffix: 'sus4' }, { id: '7sus4', name: '7sus4', suffix: '7sus4' },
            { id: 'sus2', name: 'sus2', suffix: 'sus2' },
            
            // 9th Family
            { id: 'add9', name: 'add9', suffix: 'add9' }, 
            { id: 'addb9', name: 'add(b9)', suffix: 'add(b9)' },
            { id: 'adds9', name: 'add(#9)', suffix: 'add(#9)' },
            { id: 'madd9', name: 'm(add9)', suffix: 'm(add9)' }, 
            { id: 'm9', name: 'm7(9)', suffix: 'm7(9)' }, { id: '9', name: '9', suffix: '9' }, 
            { id: '7b9', name: '7(b9)', suffix: '7(b9)' }, { id: '7s9', name: '7(#9)', suffix: '7(#9)' },
            { id: 'maj9', name: 'maj9', suffix: 'maj9' },
            { id: 'm7b9', name: 'm7(b9)', suffix: 'm7(b9)' },

            // 11th Family
            { id: 'add11', name: 'add11', suffix: 'add11' }, 
            { id: 'adds11', name: 'add(#11)', suffix: 'add(#11)' },
            { id: '11', name: '11', suffix: '11' }, { id: 'm11', name: 'm11', suffix: 'm11' }, 
            { id: '7s11', name: '7(#11)', suffix: '7(#11)' }, { id: 'maj7s11', name: 'maj7(#11)', suffix: 'maj7(#11)' }, 

            // 13th & 6th
            // { id: 'add13', name: 'add13', suffix: 'add13' }, // Removed as per request (same as 6)
            { id: 'addb13', name: 'add(b13)', suffix: 'add(b13)' },
            { id: '13', name: '7(13)', suffix: '7(13)' }, { id: 'maj13', name: 'maj7(13)', suffix: 'maj7(13)' }, { id: '7b13', name: '7(b13)', suffix: '7(b13)' }, 
            { id: 'm7_13', name: 'm7(13)', suffix: 'm7(13)' },
            { id: '6', name: '6', suffix: '6' }, { id: 'm6', name: 'm6', suffix: 'm6' }, { id: '69', name: '69', suffix: '69' },

            // Complex Altered
            { id: '7b9b13', name: '7(b9,b13)', suffix: '7(b9,b13)' }, 
            { id: '7s9b13', name: '7(#9,b13)', suffix: '7(#9,b13)' }, 
            { id: '7b9s11', name: '7(b9,#11)', suffix: '7(b9,#11)' }, 
            { id: '7complex', name: '7(b9,#11,b13)', suffix: '7(b9,#11,b13)' }, 

            // Altered 5th / Dim
            { id: 'maj7b5', name: 'Maj7(b5)', suffix: 'maj7(b5)' },
            { id: 'maj7s5', name: 'Maj7(#5)', suffix: 'maj7(#5)' },
            { id: '7b5', name: '7(b5)', suffix: '7(b5)' },
            { id: 'aug', name: 'aug', suffix: 'aug' }, { id: 'aug7', name: 'aug7', suffix: 'aug7' },
            { id: 'dim', name: 'dim', suffix: 'dim' }, { id: 'dim7', name: 'dim7', suffix: 'dim7' },
            { id: 'dimM7', name: 'dim(Maj7)', suffix: 'dim(Maj7)' },
            { id: 'm7-5', name: 'm7-5', suffix: 'm7-5' }, { id: 'mM7', name: 'mM7', suffix: 'mM7' },
            
            { id: '7sus4b9', name: '7sus4(b9)', suffix: '7sus4(b9)' }
        ];

        const CHORD_FORMULAS = {
            '': ['R', 'M3', '5'], 'm': ['R', 'm3', '5'], '7': ['R', 'M3', '5', 'b7'],
            'm7': ['R', 'm3', '5', 'b7'], 'maj7': ['R', 'M3', '5', 'M7'],
            'sus4': ['R', '4', '5'], '7sus4': ['R', '4', '5', 'b7'], 'sus2': ['R', '2', '5'],
            
            'add9': ['R', 'M3', '5', '9'], 'madd9': ['R', 'm3', '5', '9'], 
            'addb9': ['R', 'M3', '5', 'b9'], 'adds9': ['R', 'M3', '5', '#9'],
            
            'm9': ['R', 'm3', '5', 'b7', '9'], '9': ['R', 'M3', '5', 'b7', '9'],
            '7b9': ['R', 'M3', '5', 'b7', 'b9'], 'maj9': ['R', 'M3', '5', 'M7', '9'],
            'm7b9': ['R', 'm3', '5', 'b7', 'b9'],
            
            'add11': ['R', 'M3', '5', '11'], 'adds11': ['R', 'M3', '5', '#11'],
            '11': ['R', 'b7', '11'], 'm11': ['R', 'm3', '5', 'b7', '11'],
            '7s11': ['R', 'M3', '5', 'b7', '#11'], 'maj7s11': ['R', 'M3', '5', 'M7', '#11'], 
            
            '7s9': ['R', 'M3', '5', 'b7', '#9'], '13': ['R', 'M3', '5', 'b7', '13'],
            'maj13': ['R', 'M3', '5', 'M7', '13'], '7b13': ['R', 'M3', '5', 'b7', 'b13'],
            'm7_13': ['R', 'm3', '5', 'b7', '13'],
            // 'add13': ['R', 'M3', '5', '13'], 
            'addb13': ['R', 'M3', '5', 'b13'],

            'aug': ['R', 'M3', '#5'], 'aug7': ['R', 'M3', '#5', 'b7'],
            'dim': ['R', 'm3', 'b5'], 'dim7': ['R', 'm3', 'b5', 'bb7'],
            'm7-5': ['R', 'm3', 'b5', 'b7'], 'mM7': ['R', 'm3', '5', 'M7'],
            '6': ['R', 'M3', '5', '6'], 'm6': ['R', 'm3', '5', '6'], '69': ['R', 'M3', '5', '6', '9'],
            
            'maj7b5': ['R', 'M3', 'b5', 'M7'], 'maj7s5': ['R', 'M3', '#5', 'M7'], '7b5': ['R', 'M3', 'b5', 'b7'],
            'dimM7': ['R', 'm3', 'b5', 'M7'], 
            '7sus4b9': ['R', '4', '5', 'b7', 'b9'],
            
            '7b9b13': ['R', 'M3', 'b7', 'b9', 'b13'],
            '7s9b13': ['R', 'M3', 'b7', '#9', 'b13'],
            '7b9s11': ['R', 'M3', 'b7', 'b9', '#11'],
            '7complex': ['R', 'M3', 'b7', 'b9', '#11', 'b13']
        };

        const CHORD_SPECS = {
            '': { req: ['R', 'M3'], ban: ['m3'] }, 'm': { req: ['R', 'm3'], ban: ['M3'] },
            '7': { req: ['R', 'M3', 'b7'], ban: ['m3', 'M7'] }, 'm7': { req: ['R', 'm3', 'b7'], ban: ['M3', 'M7'] },
            'maj7': { req: ['R', 'M3', 'M7'], ban: ['m3', 'b7'] }, 'sus4': { req: ['R', '4', '5'], ban: ['m3', 'M3'] },
            '7sus4': { req: ['R', '4', 'b7'], ban: ['m3', 'M3'] }, 'sus2': { req: ['R', '2', '5'], ban: ['m3', 'M3'] },
            
            'add9': { req: ['R', 'M3', '9'], ban: ['m3', 'b7', 'M7'] }, 
            'madd9': { req: ['R', 'm3', '9'], ban: ['M3', 'b7', 'M7'] }, 
            'addb9': { req: ['R', 'M3', 'b9'], ban: ['m3', 'b7', 'M7'] },
            'adds9': { req: ['R', 'M3', '#9'], ban: ['m3', 'b7', 'M7'] },

            'm9': { req: ['R', 'm3', 'b7', '9'], ban: ['M3'] },
            '9': { req: ['R', 'M3', 'b7', '9'], ban: ['m3'] }, '7b9': { req: ['R', 'M3', 'b7', 'b9'], ban: ['m3'] },
            'maj9': { req: ['R', 'M3', 'M7', '9'], ban: ['m3', 'b7'] }, 
            'm7b9': { req: ['m3', 'b7', 'b9'], ban: ['M3', 'M7'] }, 
            
            'add11': { req: ['R', 'M3', '11'], ban: ['m3', 'b7', 'M7', '6'] }, 
            'adds11': { req: ['R', 'M3', '#11'], ban: ['m3', 'b7', 'M7'] },
            '11': { req: ['R', 'b7', '11'], ban: ['M3', 'm3'] }, 'm11': { req: ['R', 'm3', 'b7', '11'], ban: ['M3'] }, 
            '7s11': { req: ['R', 'M3', 'b7', '#11'], ban: ['m3', '9'] }, 
            'maj7s11': { req: ['R', 'M3', 'M7', '#11'], ban: ['m3', 'b7'] },
            
            // 'add13': { req: ['R', 'M3', '13'], ban: ['m3', 'b7', 'M7'] },
            'addb13': { req: ['R', 'M3', 'b13'], ban: ['m3', 'b7', 'M7'] },
            '13': { req: ['R', 'M3', 'b7', '13'], ban: ['m3'] }, 'maj13': { req: ['R', 'M3', 'M7', '13'], ban: ['m3', 'b7'] },
            '7b13': { req: ['R', 'M3', 'b7', 'b13'], ban: ['m3'] }, 
            'm7_13': { req: ['m3', 'b7', '13'], ban: ['M3', 'M7'] },
            
            '7s9': { req: ['R', 'M3', 'b7', '#9'], ban: [] }, 
            'aug': { req: ['R', 'M3', '#5'], ban: ['m3', '5'] },
            'aug7': { req: ['R', 'M3', '#5', 'b7'], ban: ['m3', '5'] }, 'dim': { req: ['R', 'm3', 'b5'], ban: ['M3', '5', 'b7', 'M7', '6'] }, 
            'dim7': { req: ['R', 'm3', 'b5', 'bb7'], ban: ['M3', '5', 'b7', 'M7'] }, 'm7-5': { req: ['R', 'm3', 'b5', 'b7'], ban: ['M3', '5'] },
            'mM7': { req: ['R', 'm3', 'M7'], ban: ['M3', 'b7'] }, '6': { req: ['R', 'M3', '6'], ban: ['m3', 'b7', 'M7'] },
            'm6': { req: ['R', 'm3', '6'], ban: ['M3', 'b7', 'M7'] }, '69': { req: ['R', 'M3', '6', '9'], ban: ['m3', 'b7', 'M7', 'b5', '#11'] },
            
            'maj7b5': { req: ['R', 'M3', 'b5', 'M7'], ban: ['m3', 'b7', '5'] },
            'maj7s5': { req: ['R', 'M3', '#5', 'M7'], ban: ['m3', 'b7', '5'] },
            '7b5': { req: ['R', 'M3', 'b5', 'b7'], ban: ['m3', 'M7', '5'] },
            
            'dimM7': { req: ['m3', 'b5', 'M7'], ban: ['M3', 'b7', '5'] },
            '7sus4b9': { req: ['4', 'b7', 'b9'], ban: ['m3', 'M3'] },

            '7b9b13': { req: ['R', 'M3', 'b7', 'b9', 'b13'], ban: ['m3', 'M7', '5'] },
            '7s9b13': { req: ['R', 'M3', 'b7', '#9', 'b13'], ban: ['m3', 'M7', '5'] },
            '7b9s11': { req: ['R', 'M3', 'b7', 'b9', '#11'], ban: ['m3', 'M7', '5'] },
            '7complex': { req: ['R', 'M3', 'b7', 'b9', 'b13'], ban: ['m3', 'M7', '5'] }
        };

        const TUNING_VALS = [4, 9, 2, 7, 11, 4];
        const DEGREE_NAMES = ['R', 'b9', '2', 'm3', 'M3', '4', 'b5', '5', '#5', '6', 'b7', 'M7'];

        const SHAPES = {
            '': [ { f: '022100', base: 4, n: 'E Shape' }, { f: 'x02220', base: 9, n: 'A Shape' }, { f: 'xx0232', base: 2, n: 'D Shape' } ],
            'm': [ { f: '022000', base: 4, n: 'Em Shape' }, { f: 'x02210', base: 9, n: 'Am Shape' }, { f: 'xx0231', base: 2, n: 'Dm Shape' } ],
            '7': [ { f: '020100', base: 4, n: 'E7 Shape' }, { f: 'x02020', base: 9, n: 'A7 Shape' }, { f: 'x32310', base: 0, n: 'C7 Shape' }, { f: 'xx0212', base: 2, n: 'D7 Shape' }, { f: 'x212x2', base: 11, n: 'B7 Shape' } ],
            'm7': [ { f: '020000', base: 4, n: 'Em7 Shape' }, { f: 'x02010', base: 9, n: 'Am7 Shape' }, { f: 'xx0211', base: 2, n: 'Dm7 Shape' } ],
            'maj7': [ { f: '021100', base: 4, n: 'Emaj7 Shape' }, { f: 'x02120', base: 9, n: 'Amaj7 Shape' }, { f: 'xx0222', base: 2, n: 'Dmaj7 Shape' } ],
            'sus4': [ { f: '022200', base: 4, n: 'Esus4 Shape' }, { f: 'x02230', base: 9, n: 'Asus4 Shape' }, { f: 'xx0233', base: 2, n: 'Dsus4 Shape' }, { f: '3x0013', base: 7, n: 'Gsus4 Shape' } ],
            '7sus4': [ { f: 'x02030', base: 9, n: 'A7sus4 Shape' }, { f: '3x0211', base: 7, n: 'G7sus4 Shape' }, { f: 'xx0213', base: 2, n: 'D7sus4 Shape' } ],
            'sus2': [ { f: 'x02200', base: 9, n: 'Asus2 Shape' }, { f: 'xx0230', base: 2, n: 'Dsus2 Shape' } ],
            
            // 9th
            'add9': [ { f: '022102', base: 4, n: 'Eadd9 Shape' }, { f: 'x32030', base: 0, n: 'Cadd9 Shape' }, { f: 'xx3213', base: 5, n: 'Fadd9 Shape' }, { f: 'x21x22', base: 11, n: 'Badd9 Shape' } ],
            'addb9': [ { f: '022101', base: 4, n: 'E(addb9)' }, { f: 'x32020', base: 0, n: 'C(addb9)' } ],
            'adds9': [ { f: '022103', base: 4, n: 'E(add#9)' }, { f: 'x02201', base: 9, n: 'A(add#9)' } ],
            'madd9': [ { f: '024000', base: 4, n: 'Em(add9) Open' }, { f: 'x02410', base: 9, n: 'Am(add9) Open' }, { f: 'xx3230', base: 2, n: 'Dm(add9) Triad' }, { f: '577557', base: 9, n: 'Am(add9) Barre' } ],
            '9': [ { f: '020102', base: 4, n: 'E9 Shape' }, { f: 'x21222', base: 11, n: 'B9 Shape' }, { f: 'x3233x', base: 0, n: 'C9 Shape' } ],
            '7b9': [ { f: 'x3232x', base: 0, n: 'C7(b9) Shape' }, { f: 'x02323', base: 9, n: 'A7(b9) Shape' }, { f: '020101', base: 4, n: 'E7(b9) Shape' } ],
            'm9': [ { f: '020002', base: 4, n: 'Em9 Shape' }, { f: 'x20222', base: 11, n: 'Bm9 Shape' }, { f: 'x2022x', base: 11, n: 'Bm9 Shape' }, { f: 'x3133x', base: 0, n: 'Cm9 Shape' }, { f: 'xx1333', base: 0, n: 'Cm9 Rootless' } ], 
            'maj9': [ { f: 'x3243x', base: 0, n: 'Cmaj9 Shape' }, { f: '021102', base: 4, n: 'Emaj9 Shape' }, { f: 'x30000', base: 0, n: 'Cmaj9 Open' }, { f: '3x0202', base: 7, n: 'Gmaj9 Open' }, { f: 'x8798x', base: 5, n: 'Fmaj9 Shell' }, { f: 'xx2433', base: 0, n: 'Cmaj9 Rootless' } ],
            'm7b9': [ { f: 'x3132x', base: 0, n: 'Cm7(b9) Shell' }, { f: '5x556x', base: 9, n: 'Am7(b9) Shell' }, { f: 'x05556', base: 9, n: 'Am7(b9) High' }, { f: 'x5334x', base: 2, n: 'Dm7(b9) Shape' } ],

            // 11th
            'add11': [ { f: 'x32011', base: 0, n: 'Cadd11 Shape' }, { f: '320013', base: 7, n: 'Gadd11 Shape' }, { f: '002100', base: 4, n: 'Eadd11 Open' } ],
            'adds11': [ { f: '022300', base: 4, n: 'E(add#11)' }, { f: 'x02224', base: 9, n: 'A(add#11)' }, { f: '3x0002', base: 7, n: 'G(add#11)' } ],
            '11': [ { f: '3x3211', base: 7, n: 'G11 (F/G)' }, { f: 'x53553', base: 0, n: 'C11 (Bb/C)' }, { f: 'x00010', base: 2, n: 'D11 (C/D)' } ],
            'm11': [ { f: '000000', base: 4, n: 'Em11 Open' }, { f: 'x00010', base: 9, n: 'Am11 Open' }, { f: '3x331x', base: 7, n: 'Gm11 Shape' }, { f: '7x775x', base: 11, n: 'Bm11 Shape' } ],
            '7s11': [ { f: '2x231x', base: 6, n: 'F#7(#11) No9' }, { f: 'x3434x', base: 0, n: 'C7(#11) No9' }, { f: '1x120x', base: 5, n: 'F7(#11) No9' } ],
            '9s11': [ { f: 'x32332', base: 0, n: 'C9(#11) Shape' }, { f: 'x54554', base: 2, n: 'D9(#11) Shape' } ],
            'maj7s11': [ { f: '133200', base: 5, n: 'Fmaj7(#11)' }, { f: 'x3244x', base: 0, n: 'Cmaj7(#11) Shell' }, { f: '8x997x', base: 0, n: 'Cmaj7(#11) High' }, { f: 'x02140', base: 9, n: 'Amaj7(#11)' }, { f: '2x331x', base: 6, n: 'F#maj7(#11)' } ],
            
            // 13th
            // 'add13': [ { f: '022120', base: 4, n: 'E(add13)' }, { f: 'x02222', base: 9, n: 'A(add13)' } ],
            'addb13': [ { f: '022110', base: 4, n: 'E(addb13)' }, { f: 'x02211', base: 9, n: 'A(addb13)' } ],
            '13': [ { f: '3x3455', base: 7, n: 'G13 Rich' }, { f: '020120', base: 4, n: 'E13 Shape' }, { f: '2x234x', base: 6, n: 'F#13 Shape' }, { f: 'xx3455', base: 7, n: 'G13 Rootless' } ], 
            'maj13': [ { f: '3x445x', base: 7, n: 'Gmaj13 Shape' }, { f: '1x223x', base: 5, n: 'Fmaj13 Shape' }, { f: 'x13233', base: 10, n: 'Bbmaj13 Shape' }, { f: 'x02122', base: 9, n: 'Amaj13 Shape' } ], 
            '7b13': [ { f: '3x344x', base: 7, n: 'G7(b13) Shape', flags: ['nb'] }, { f: 'x13132', base: 10, n: 'Bb7(b13) Shape' }, { f: 'x02021', base: 9, n: 'A7(b13) Shape' } ],
            'm7_13': [ { f: '5x557x', base: 9, n: 'Am7(13) Shell' }, { f: 'x5666x', base: 2, n: 'Dm7(13) Shell' }, { f: 'x53355', base: 2, n: 'Dm7(13) Full' } ],

            // Altered / Dim
            'aug': [ { f: 'x3211x', base: 0, n: 'Caug Shape' }, { f: 'xx0332', base: 2, n: 'Daug Shape' }, { f: 'x0322x', base: 9, n: 'Aaug Shape' }, { f: 'xx2110', base: 4, n: 'Eaug Shape' }, { f: '32100x', base: 7, n: 'Gaug Shape' } ],
            'aug7': [ { f: '0x0110', base: 4, n: 'Eaug7 Shape' }, { f: 'x03021', base: 9, n: 'Aaug7 Shape' }, { f: '2x233x', base: 6, n: 'F#aug7 Shape' }, { f: 'x32314', base: 0, n: 'Caug7 Open' } ],
            'dim': [ { f: 'xx0131', base: 2, n: 'Ddim Shape' }, { f: 'x0121x', base: 9, n: 'Adim Shape' }, { f: 'xx121x', base: 3, n: 'Ebdim Shape' }, { f: 'xx454x', base: 6, n: 'F#dim Shape' } ], 
            'dim7': [ { f: 'xx1212', base: 3, n: '4th Root' }, { f: 'x01212', base: 9, n: '5th Root' }, { f: '3x232x', base: 7, n: '6th Root' }, { f: 'x1202x', base: 10, n: 'Bbdim7 Shape' } ],
            'dimM7': [ { f: 'x0111x', base: 9, n: 'Adim(Maj7) Open' }, { f: 'x3444x', base: 0, n: 'Cdim(Maj7)' }, { f: 'xx1213', base: 3, n: 'Ebdim(Maj7)' }, { f: '2x121x', base: 6, n: 'F#dim(Maj7)' } ],
            'm7-5': [ { f: 'x0101x', base: 9, n: 'Am7-5 NoTop' }, { f: 'x01013', base: 9, n: 'Am7-5 Shape' }, { f: 'xx0111', base: 2, n: 'Dm7-5 Shape' }, { f: '2x221x', base: 6, n: 'F#m7-5 Shape' }, { f: 'x3434x', base: 0, n: 'Cm7-5 Shape' } ],
            'mM7': [ { f: 'x02110', base: 9, n: 'AmM7 Shape' }, { f: '021000', base: 4, n: 'EmM7 Shape' }, { f: 'xx0221', base: 2, n: 'DmM7 Shape' } ],
            '6': [ { f: '022120', base: 4, n: 'E6 Shape' }, { f: 'x02222', base: 9, n: 'A6 Shape' }, { f: 'x32210', base: 0, n: 'C6 Shape' }, { f: '320000', base: 7, n: 'G6 Shape' }, { f: 'xx0202', base: 2, n: 'D6 Shape' }, { f: 'x1303x', base: 10, n: 'Bb6 Shape' } ],
            'm6': [ { f: '022020', base: 4, n: 'Em6 Shape' }, { f: 'x02212', base: 9, n: 'Am6 Shape' }, { f: 'x2010x', base: 11, n: 'Bm6 Shape' }, { f: 'x1x021', base: 10, n: 'Bbm6 Shape' }, { f: '1x011x', base: 5, n: 'Fm6 Shape' } ],
            '69': [ { f: '322200', base: 7, n: 'G69 Shape' }, { f: 'x32233', base: 0, n: 'C69 Shape' }, { f: '5444xx', base: 9, n: 'A69 Shape' } ],

            'maj7b5': [ { f: 'xx0120', base: 2, n: 'Dmaj7(b5) Shape' }, { f: 'x3444x', base: 0, n: 'Cmaj7(b5) Shell' } ],
            'maj7s5': [ { f: 'x3645x', base: 0, n: 'Cmaj7(#5)' }, { f: '1x122x', base: 5, n: 'Fmaj7(#5)' }, { f: '3x444x', base: 7, n: 'Gmaj7(#5)' } ],
            '7b5': [ { f: 'x1213x', base: 10, n: 'Bb7(b5)' }, { f: '2x233x', base: 6, n: 'F#7(b5) Shell' }, { f: '012030', base: 4, n: 'E7(b5) Open' } ],
            '7sus4b9': [ { f: '3x311x', base: 7, n: 'G7sus4(b9)' }, { f: '020201', base: 4, n: 'E7sus4(b9) Open' }, { f: 'x5556x', base: 2, n: 'D7sus4(b9)' } ],
            
            // Complex
            '7b9b13': [ { f: '020111', base: 4, n: 'E7(b9,b13) Full' }, { f: 'x32324', base: 0, n: 'C7(b9,b13) Stretch' }, { f: 'x21213', base: 11, n: 'B7(b9,b13)' } ],
            '7s9b13': [ { f: '020131', base: 4, n: 'E7(#9,b13)' }, { f: 'x32344', base: 0, n: 'C7(#9,b13)' } ],
            '7b9s11': [ { f: '010111', base: 4, n: 'E7(b9,#11)' }, { f: 'x32322', base: 0, n: 'C7(b9,#11)' } ],
            '7complex': [ { f: '010111', base: 4, n: 'E7(b9,#11,b13) No3' }, { f: '121222', base: 5, n: 'F7 Alt Full' } ]
        };

        const SLASH_TEMPLATES = {
            '': [ { f: '022100', base: 9, bassInterval: 7, n: '/5 (A-form)' }, { f: '022100', base: 4, bassInterval: 4, n: '/3 (E-form)' }, { f: '2x0232', base: 2, bassInterval: 4, n: '/3 (D-form)' } ],
            'm': [ { f: '3x2210', base: 9, bassInterval: 10, n: '/b7 (Am/G)' }, { f: '2x2210', base: 9, bassInterval: 9, n: '/6 (Am/F#)' }, { f: '322000', base: 4, bassInterval: 3, n: '/b3 (Em/G)' } ],
            '7': [ { f: '2x0212', base: 2, bassInterval: 4, n: '/3 (D7/F#)' }, { f: '002020', base: 9, bassInterval: 7, n: '/5 (A7/E)' } ],
            'maj7': [ { f: '332000', base: 0, bassInterval: 7, n: '/5 (Cmaj7/G)' } ]
        };

        const MANUAL_OVERRIDES = {
            'C': { 
                std: [{f:'x32010', n:'Open'}, {f:'x35553', n:'A Shape'}], 
                slash: [
                    {b:'E', f:'032010', n:'/3 (on E)'}, 
                    {b:'G', f:'332010', n:'/5 (on G)'}, 
                    {b:'F', f:'132010', n:'/11 (on F)'}
                ] 
            },
            'Cmaj7': {
                std: [{f:'x32000', n:'Open'}, {f:'x32000', n:'Drop 2 Open'}, {f:'x35453', n:'Cmaj7 Shape'}]
            },
            'Cm': { slash: [{b:'Eb', f:'xx1013', n:'/b3 (Open Style)'}, {b:'Eb', f:'x65543', n:'/b3 (High)'}] }, 
            'C7': { slash: [{b:'E', f:'032310', n:'/3 (on E)'}, {b:'Bb', f:'x12010', n:'/b7 (on Bb)'}] },
            'G': { 
                std: [{f:'320003', n:'Open'}, {f:'320033', n:'Pop'}, {f:'355433', n:'E Shape'}], 
                slash: [
                    {b:'B', f:'x20003', n:'/3 (on B)'}, 
                    {b:'D', f:'xx0003', n:'/5 (on D)'},
                    {b:'F#', f:'2x0003', n:'/7 (on F#)'} 
                ] 
            },
            'D': { 
                std: [{f:'xx0232', n:'Open'}, {f:'x57775', n:'A Shape'}], 
                slash: [
                    {b:'F#', f:'2x0232', n:'/3 (on F#)'}, 
                    {b:'A', f:'x00232', n:'/5 (on A)'}, 
                    {b:'C', f:'x30232', n:'/b7 (on C)'}
                ] 
            },
            'A': { 
                std: [{f:'x02220', n:'Open'}, {f:'577655', n:'E Shape'}], 
                slash: [
                    {b:'C#', f:'x42220', n:'/3 (on C#)'}, 
                    {b:'E', f:'002220', n:'/5 (on E)'},
                    {b:'G', f:'3x2220', n:'/b7 (on G)'}
                ] 
            },
            'E': { 
                std: [{f:'022100', n:'Open'}], 
                slash: [
                    {b:'G#', f:'4x2100', n:'/3 (on G#)'}, 
                    {b:'B', f:'x22100', n:'/5 (on B)'}
                ] 
            },
            'Am': { 
                std: [{f:'x02210', n:'Open'}],
                slash: [
                    {b:'G', f:'3x2210', n:'/b7 (on G)'}, 
                    {b:'F#', f:'2x2210', n:'/6 (on F#)'},
                    {b:'E', f:'002210', n:'/5 (on E)'}
                ] 
            },
            'Em': { 
                std: [{f:'022000', n:'Open'}], 
                slash: [
                    {b:'B', f:'x22000', n:'/5 (on B)'}, 
                    {b:'D', f:'xx0000', n:'/b7 (on D)'}, 
                    {b:'C#', f:'x42000', n:'/6 (on C#)'}
                ] 
            },
            'F': { 
                std: [{f:'133211', n:'Barre'}, {f:'x33211', n:'Barre 5-str'}], 
                slash: [
                    {b:'C', f:'x33211', n:'/5 (on C)'}, 
                    {b:'A', f:'x03211', n:'/3 (on A)'},
                    {b:'G', f:'3x3211', n:'/2 (on G)'}
                ] 
            },
            'Dm': { 
                std: [{f:'xx0231', n:'Open'}],
                slash: [
                    {b:'C', f:'x30231', n:'/b7 (on C)'}, 
                    {b:'B', f:'x20231', n:'/6 (on B)'}, 
                    {b:'Bb', f:'x10231', n:'/b6 (on Bb)'},
                    {b:'A', f:'x00231', n:'/5 (on A)'}
                ] 
            },
            'Bb': {
                std: [{f:'x13331', n:'A Shape'}, {f:'688766', n:'E Shape'}],
                slash: [
                    {b:'D', f:'xx0331', n:'/3 (on D)'},
                    {b:'F', f:'113331', n:'/5 (on F)'}
                ]
            },
            'Bb7b9b13': { // Custom form
                std: [{f:'x10102', n:'Bb7(b9,b13)'}] 
            },
            'Db': { slash: [{b:'Ab', f:'4x666x', n:'/5 (on Ab)'}] },
            'Eb': { slash: [{b:'Bb', f:'6x888x', n:'/5 (on Bb)'}] },
            'Ab': { slash: [{b:'Eb', f:'x66544', n:'/5 (on Eb)'}] },
            'B': {
                std: [{f:'x24442', n:'A Shape'}, {f:'799877', n:'E Shape'}, {f:'x21202', n:'B7 Open'}],
                slash: [
                    {b:'D#', f:'x6444x', n:'/3 (on D#)'},
                    {b:'Gb', f:'2x444x', n:'/5 (on F#)'}, {b:'F#', f:'2x444x', n:'/5 (on F#)'}
                ] 
            },
            'Cadd9': { std: [{f: 'x32030', n: 'Open'}, {f: 'x32033', n: 'Open 2'}] },
            'Am7-5': { std: [{f: 'x0101x', n: 'Open'}] },
            'Bbdim7': { std: [{f: 'x12020', n: 'Open'}] },
            'Caug7': { std: [{f: 'x32314', n: 'Open Stretch'}] }
        };

        const CHORD_DB = {};
        let availableTypes = new Set();
        
        let subIndices = {};

        const parseFrets = (str) => {
            if(!str) return [-1,-1,-1,-1,-1,-1];
            return str.split('').map(c => {
                if(c === 'x') return -1;
                if(c === 'a') return 10; if(c === 'b') return 11; if(c === 'c') return 12;
                if(c === 'd') return 13; if(c === 'e') return 14;
                return parseInt(c);
            });
        };
        const toHex = (n) => {
            if(n === -1) return 'x';
            if(n === 10) return 'a'; if(n === 11) return 'b'; if(n === 12) return 'c';
            if(n === 13) return 'd'; if(n === 14) return 'e';
            return n.toString();
        };

        const getMinFret = (fStr) => {
            const arr = parseFrets(fStr).filter(x=>x>0);
            return arr.length ? Math.min(...arr) : 0;
        };
        const hasOpen = (fStr) => parseFrets(fStr).includes(0);

        const isPlayable = (frets) => {
            const actives = frets.filter(f => f > 0);
            if (actives.length === 0) return true;
            if ((Math.max(...actives) - Math.min(...actives)) > 5) return false;
            
            const fretCounts = {};
            actives.forEach(f => { fretCounts[f] = (fretCounts[f] || 0) + 1; });
            const maxFretCount = Math.max(...Object.values(fretCounts));
            
            const min = Math.min(...actives);
            const countAtMin = frets.filter(f => f === min).length;
            let isBarre = (countAtMin >= 2 && !frets.includes(0));
            
            let fingerCount = 0;
            if (isBarre) {
                fingerCount = 1; 
                frets.forEach(f => { if(f > min) fingerCount++; });
            } else if (maxFretCount >= 3 && !frets.includes(0)) {
                const clusterFret = parseInt(Object.keys(fretCounts).find(k => fretCounts[k] >= 3));
                const clusterStrings = frets.map((f, i) => f === clusterFret ? i : -1).filter(i => i !== -1);
                const minStr = Math.min(...clusterStrings);
                const maxStr = Math.max(...clusterStrings);
                
                let possible = true;
                for(let s = minStr; s <= maxStr; s++) {
                    if (frets[s] !== -1 && frets[s] < clusterFret) {
                        possible = false; // Cannot barre over a lower note
                        break;
                    }
                }
                
                if (possible) {
                    const uniqueFrets = new Set(actives);
                    fingerCount = uniqueFrets.size;
                } else {
                    frets.forEach(f => { if(f > 0) fingerCount++; });
                }
            } else {
                frets.forEach(f => { if(f > 0) fingerCount++; });
            }
            return fingerCount <= 4;
        };

        function getDegrees(rootVal, fStr, typeId) {
            const frets = parseFrets(fStr);
            const degrees = new Set();
            frets.forEach((f, i) => {
                if (f !== -1) {
                    const info = getLabel(rootVal, i, f, typeId);
                    if (info) degrees.add(info.d);
                }
            });
            return degrees;
        }

        function generateAll() {
            availableTypes.clear();
            const strictTypes = [
                'm7b9', 'dimM7', '7sus4b9', 'm7_13', 
                'adds9', 'addb9', 'adds11', 'add13', 'addb13', 
                '7b9b13', '7s9b13', '7b9s11', '7complex', 'madd9',
                '7b5', 'maj7b5', 'maj7s5', 'm7-5', 'aug', 'aug7'
            ];

            ROOTS.forEach(root => {
                TYPES.forEach(type => {
                    if (type.id === 'ALL') return;
                    const key = root.name + type.id;
                    let list = [];
                    let slashList = [];

                    const tmpls = SHAPES[type.id] || [];
                    tmpls.forEach(tmpl => {
                        let diff = (root.val - tmpl.base + 12) % 12;
                        const baseFrets = parseFrets(tmpl.f);
                        const newFrets = baseFrets.map(f => f === -1 ? -1 : f + diff);
                        
                        if (Math.max(...newFrets) <= 14 && isPlayable(newFrets)) {
                            const fStr = newFrets.map(toHex).join('');
                            const degs = getDegrees(root.val, fStr, type.id);
                            const rules = CHORD_SPECS[type.id] || { req: [], ban: [] };
                            const bans = rules.ban || [];
                            const reqs = rules.req || [];
                            
                            const hasBanned = bans.some(b => degs.has(b));
                            
                            let hasRequired = true;
                            if (strictTypes.includes(type.id)) {
                                hasRequired = reqs.every(r => degs.has(r));
                            }

                            if (!hasBanned && hasRequired && !list.some(x => x.f === fStr)) {
                                let name = tmpl.n;
                                if (diff === 0) name = "Open / Base";
                                else if (Math.min(...newFrets.filter(f=>f>0)) > 0) name = "Barre";
                                list.push({ f: fStr, n: name, flags: tmpl.flags || [] });
                            }
                        }
                    });

                    const slashTmpls = SLASH_TEMPLATES[type.id] || [];
                    slashTmpls.forEach(tmpl => {
                         let diff = (root.val - tmpl.base + 12) % 12;
                         const baseFrets = parseFrets(tmpl.f);
                         const newFrets = baseFrets.map(f => f === -1 ? -1 : f + diff);
                         
                         if (Math.max(...newFrets) <= 14 && isPlayable(newFrets)) {
                             const fStr = newFrets.map(toHex).join('');
                             const bassVal = (root.val + tmpl.bassInterval) % 12;
                             const bassName = ROOTS.find(r => r.val === bassVal).name;
                             if(!slashList.some(x => x.bass === bassName && x.f === fStr)) {
                                 slashList.push({ bass: bassName, f: fStr, flags: tmpl.flags || [] });
                             }
                         }
                    });

                    if (MANUAL_OVERRIDES[key]) {
                        if (MANUAL_OVERRIDES[key].std) {
                            MANUAL_OVERRIDES[key].std.forEach(m => {
                                const idx = list.findIndex(x => x.f === m.f);
                                if(idx > -1) list.splice(idx, 1);
                                list.unshift({ ...m, flags: m.flags || [] });
                            });
                        }
                        if (MANUAL_OVERRIDES[key].slash) {
                            const manualSlashes = MANUAL_OVERRIDES[key].slash;
                            slashList = slashList.filter(s => !manualSlashes.some(m => m.b === s.bass));
                            const formattedManual = manualSlashes.map(m => ({ bass: m.b, f: m.f, flags: m.flags || [] }));
                            slashList = [...formattedManual, ...slashList];
                        }
                    }
                    
                    if(key === 'C7' && !slashList.some(s => s.bass === 'E')) {
                         slashList.unshift({ bass: 'E', f: '032310', n: '/3 (on E)' });
                    }

                    list.sort((a,b) => {
                        const aOp = hasOpen(a.f), bOp = hasOpen(b.f);
                        if(aOp && !bOp) return -1;
                        if(!aOp && bOp) return 1;
                        return getMinFret(a.f) - getMinFret(b.f);
                    });
                    
                    CHORD_DB[key] = { std: list, slash: slashList };
                    
                    if (list.length > 0 || slashList.length > 0) {
                        availableTypes.add(type.id);
                    }
                });
            });
            document.getElementById('status-msg').innerText = "Ready";
        }

        let audioCtx;
        let state = { root: 'ALL', type: 'ALL', chordSelection: {}, stdIndices: {}, displayMode: 'note', tone: 'acoustic' };

        async function initAudio() {
            if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') await audioCtx.resume();
        }
        function setGuitarTone(tone) { state.tone = tone; }

        function playString(freq, time, toneType) {
            const t = time;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            
            const noiseBuffer = audioCtx.createBuffer(1, 100, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < 100; i++) output[i] = Math.random() * 2 - 1;
            const noiseSrc = audioCtx.createBufferSource();
            noiseSrc.buffer = noiseBuffer;
            const noiseGain = audioCtx.createGain();

            let attack = 0.02, decay = 1.5, volume = 0.4;
            if (toneType === 'acoustic') {
                osc.type = 'sawtooth';
                filter.type = 'lowpass'; filter.frequency.setValueAtTime(8000, t);
                filter.frequency.exponentialRampToValueAtTime(1000, t + 0.15);
                filter.Q.value = 0.5; decay = 2.0; noiseGain.gain.value = 0.2;
            } else if (toneType === 'nylon') {
                osc.type = 'triangle';
                filter.type = 'lowpass'; filter.frequency.setValueAtTime(3000, t);
                filter.frequency.exponentialRampToValueAtTime(300, t + 0.2);
                attack = 0.04; decay = 1.5; noiseGain.gain.value = 0.05; volume=0.5;
            } else if (toneType === 'clean') {
                osc.type = 'triangle';
                filter.type = 'lowpass'; filter.frequency.setValueAtTime(4000, t);
                filter.Q.value = 1; decay = 3.0; noiseGain.gain.value = 0.1;
            } else if (toneType === 'drive') {
                osc.type = 'sawtooth';
                filter.type = 'bandpass'; filter.frequency.setValueAtTime(1500, t);
                filter.Q.value = 1.5; decay = 2.0; volume = 0.2;
            }

            osc.frequency.setValueAtTime(freq, t);
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(volume, t + attack);
            gainNode.gain.exponentialRampToValueAtTime(0.001, t + attack + decay);
            
            osc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
            noiseSrc.connect(noiseGain); noiseGain.connect(audioCtx.destination);
            noiseGain.gain.setValueAtTime(noiseGain.gain.value, t);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);

            osc.start(t); osc.stop(t+attack+decay); noiseSrc.start(t);
        }

        window.playNote = async (strIndex, fret) => {
            if(fret === -1) return;
            await initAudio();
            const BASE_FREQS = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];
            const freq = BASE_FREQS[strIndex] * Math.pow(2, fret/12);
            playString(freq, audioCtx.currentTime, state.tone);
        };

        async function playChord(fStr) {
            await initAudio();
            const frets = parseFrets(fStr);
            const now = audioCtx.currentTime;
            const strumSpeed = 0.04;
            const BASE_FREQS = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];

            frets.forEach((f, i) => {
                if(f !== -1) {
                    const freq = BASE_FREQS[i] * Math.pow(2, f/12);
                    const timeOffset = i * strumSpeed + (Math.random() * 0.005);
                    playString(freq, now + timeOffset, state.tone);
                }
            });
        }

        function getLabel(rootVal, str, fret, typeId) {
            if (fret === -1) return null;
            const nVal = (TUNING_VALS[str] + fret) % 12;
            const interval = (nVal - rootVal + 12) % 12;
            const name = ROOTS[nVal].name;

            let degree = DEGREE_NAMES[interval];
            
            if (interval === 2) { if (typeId === 'sus2') {} else { degree = '9'; } }
            if (typeId === '7s9' && interval === 3) degree = '#9';
            if (typeId === '7b9' && interval === 1) degree = 'b9';

            if (typeId === 'dim7' && interval === 9) degree = 'bb7';
            if (typeId.includes('13') && interval === 9) degree = '13';
            if (typeId.includes('b13') && interval === 8) degree = 'b13';
            if ((typeId === 'aug' || typeId === 'aug7') && interval === 8) degree = '#5';
            if (typeId.includes('6') && interval === 9) degree = '6';
            if (typeId === '69') { if (interval === 2) degree = '9'; if (interval === 9) degree = '6'; }
            if (typeId === '7sus4' && interval === 5) degree = '4';
            if (interval === 5) { if(typeId.includes('11') || typeId.includes('sus')) degree = (typeId.includes('sus') ? '4' : '11'); }
            if (interval === 6) { if(typeId.includes('s11') || typeId.includes('#11')) degree = '#11'; else if(typeId.includes('-5') || typeId.includes('dim') || typeId.includes('b5')) degree = 'b5'; }

            return { n: name, d: degree, isR: interval===0 };
        }

        function drawBoard(frets, rootVal, typeId, uid, flags = []) {
            const W=740, H=200, nut=40, fW=45;
            let svg = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
            svg += `<rect x="${nut}" y="20" width="${W-nut-10}" height="135" class="fretboard-bg" rx="4"/>`;
            svg += `<line x1="${nut}" y1="20" x2="${nut}" y2="155" stroke="#999" stroke-width="6"/>`;
            for(let f=1; f<=15; f++){
                let x = nut + f*fW;
                svg += `<line x1="${x}" y1="20" x2="${x}" y2="155" class="fret-wire" stroke-width="2"/>`;
                if([3,5,7,9,15].includes(f)) svg+= `<circle cx="${x-fW/2}" cy="87.5" r="6" class="inlay"/>`;
                if(f===12) { svg+= `<circle cx="${x-fW/2}" cy="60" r="6" class="inlay"/><circle cx="${x-fW/2}" cy="115" r="6" class="inlay"/>`; }
                if([1,3,5,7,9,12,15].includes(f)) svg+= `<text class="fret-num" x="${x-fW/2}" y="175">${f}</text>`;
            }
            for(let i=0; i<6; i++){
                let y = 35 + (5-i)*22;
                let cls = i<3 ? 'string-wound' : 'string-plain';
                let isMuted = frets[i] === -1;
                let op = isMuted ? 0.25 : (i<3 ? 0.9 : 0.8); 
                svg += `<line x1="${nut-10}" y1="${y}" x2="${W}" y2="${y}" class="${cls}" stroke-width="${1+(1-i/5)}" style="opacity: ${op};"/>`;
            }
            const acts = frets.filter(f=>f>0);
            if(acts.length>=2 && !frets.includes(0) && !flags.includes('nb')) {
                let min = Math.min(...acts);
                if(frets.filter(f=>f===min).length >= 2) {
                    let sI = frets.findIndex(f=>f===min);
                    let eI = 5 - [...frets].reverse().findIndex(f=>f===min);
                    let y1 = 35 + (5-sI)*22; 
                    let y2 = 35 + (5-eI)*22;
                    svg += `<rect x="${nut+min*fW-fW/2-14}" y="${Math.min(y1,y2)-14}" width="28" height="${Math.abs(y1-y2)+28}" rx="14" fill="#3b82f6" fill-opacity="0.4"/>`;
                }
            }
            frets.forEach((f, i) => {
                let y = 35 + (5-i)*22;
                if(f===-1) {
                    svg += `<text x="${nut/2}" y="${y}" class="mute-mark" font-size="20">√ó</text>`;
                } else {
                    let info = getLabel(rootVal, i, f, typeId);
                    let col = info.isR ? '#ef4444' : '#2563eb';
                    let cx = f===0 ? nut/2 : nut + f*fW - fW/2;
                    
                    let evt = `onclick="playNote(${i}, ${f}); event.stopPropagation();"`;
                    
                    svg += `<circle cx="${cx}" cy="${y}" r="13" fill="${col}" stroke="white" stroke-width="1.5" class="note-circle note-interactive" ${evt}/>`;
                    let txt = state.displayMode==='note' ? info.n : info.d;
                    svg += `<text class="svg-text n-lbl note-interactive" data-n="${info.n}" data-d="${info.d}" x="${cx}" y="${y}" fill="white" font-size="${txt.length>2?9:11}" ${evt}>${txt}</text>`;
                }
            });
            return svg + `</svg>`;
        }

        window.setR = v => { 
            state.root = v; 
            if(v === 'ALL') state.type = 'ALL'; 
            render(); 
        };
        window.setT = v => { state.type = v; render(); };
        window.selB = (k,b) => { state.chordSelection[k]=b; updateCard(k); };
        window.chgStd = (k,d) => {
            const currentMode = state.chordSelection[k] || 'std';
            const subKey = `${k}-${currentMode}`;
            let patterns = [];
            const data = CHORD_DB[k];
            if(currentMode === 'std') {
                patterns = data.std;
            } else {
                patterns = data.slash.filter(s => s.bass === currentMode);
            }
            if(patterns.length === 0) return;
            const len = patterns.length;
            let i = subIndices[subKey] || 0;
            subIndices[subKey] = (i + d + len) % len;
            updateCard(k);
        };

        window.toggleDisplayMode = m => {
            state.displayMode=m;
            updModeBtns();
            document.querySelectorAll('.n-lbl').forEach(e => {
                let t = m==='note' ? e.getAttribute('data-n') : e.getAttribute('data-d');
                e.textContent = t;
                e.setAttribute('font-size', t.length>2?9:11);
            });
        };

        function render() {
            let rh = `<button onclick="setR('ALL')" class="bass-btn all-btn ${state.root==='ALL'?'active':''}">All</button>`;
            ROOTS.forEach(r => rh += `<button onclick="setR('${r.name}')" class="bass-btn ${state.root===r.name?'active':''}">${r.name}</button>`);
            document.getElementById('root-filters').innerHTML = rh;
            
            let th = ``;
            // Add ALL button for Type
            th += `<button onclick="setT('ALL')" class="bass-btn all-btn ${state.type==='ALL'?'active':''}">All</button>`;
            
            TYPES.forEach(t => {
                if (t.id === 'ALL') return; // Already added above
                if(!availableTypes.has(t.id)) return; // Only show types that have generated chords
                th += `<button onclick="setT('${t.id}')" class="bass-btn ${state.type===t.id?'active':''} min-w-max">${t.name}</button>`;
            });
            document.getElementById('type-filters').innerHTML = th;

            const grid = document.getElementById('chord-grid');
            
            const existingCards = grid.querySelectorAll('.chord-card');
            existingCards.forEach(card => card.style.display = 'none');

            let c = 0;

            ROOTS.forEach(root => {
                if(state.root!=='ALL' && state.root!==root.name) return;
                TYPES.forEach(type => {
                    if(type.id==='ALL') return;
                    if(state.type!=='ALL' && state.type!==type.id) return;
                    
                    const key = root.name + type.id;
                    const data = CHORD_DB[key];
                    if(!data) return;
                    
                    if(data.std.length === 0 && data.slash.length === 0) return;

                    c++;
                    
                    let card = document.getElementById(`card-${key}`);
                    if (!card) {
                        card = document.createElement('div');
                        card.className = 'chord-card p-4';
                        card.id = `card-${key}`;
                        grid.appendChild(card);
                        updateCard(key, true);
                    }

                    card.style.display = 'flex';
                });
            });
            document.getElementById('no-results').className = c===0?'text-center py-20 text-gray-500':'hidden';
        }

        function updateCard(key, isInit = false) {
            const card = document.getElementById(`card-${key}`);
            if(!card) return;
            
            const data = CHORD_DB[key];
            const sel = state.chordSelection[key] || 'std';
            const subKey = `${key}-${sel}`;
            const idx = subIndices[subKey] || 0;
            
            let pat, patterns = [];
            let isS = false;
            
            if(sel === 'std') {
                patterns = data.std;
            } else {
                patterns = data.slash.filter(s => s.bass === sel);
                isS = true;
            }
            
            if(patterns.length === 0) { pat = { f: 'xxxxxx', n: 'No Data' }; }
            else { pat = patterns[idx % patterns.length]; }
            
            let rootName = '', typeId = '';
            const sortedRoots = [...ROOTS].sort((a,b) => b.name.length - a.name.length);
            for(let r of sortedRoots) {
                if(key.startsWith(r.name)) {
                    let suffix = key.substring(r.name.length);
                    if(TYPES.some(t => t.id === suffix)) {
                        rootName = r.name;
                        typeId = suffix;
                        break;
                    }
                }
            }
            const rootObj = ROOTS.find(r => r.name === rootName);
            const typeObj = TYPES.find(t => t.id === typeId);
            const title = isS ? `${rootName}${typeObj.suffix}<span class="text-yellow-500">/${sel}</span>` : `${rootName}${typeObj.suffix}`;
            
            let omitHTML = '';
            let actualDegrees = new Set();
            if(pat.f !== 'xxxxxx') actualDegrees = getDegrees(rootObj.val, pat.f, typeId);
            const idealDegrees = CHORD_FORMULAS[typeId] || [];
            const missing = idealDegrees.filter(d => !actualDegrees.has(d));
            if (missing.length > 0) {
                let isWarning = false;
                if (missing.includes('3') || missing.includes('m3') || missing.includes('M3') || 
                    missing.includes('7') || missing.includes('b7') || missing.includes('M7') || 
                    missing.includes('bb7')) isWarning = true;
                if (typeId.includes('9') && missing.includes('9')) isWarning = true;
                if (typeId.includes('11') && (missing.includes('11') || missing.includes('#11'))) isWarning = true;
                if (typeId.includes('13') && missing.includes('13')) isWarning = true;
                if (typeId.includes('6') && missing.includes('6')) isWarning = true;
                let badgeClass = 'omit-badge';
                if (missing.includes('R')) { badgeClass += ' rootless'; isWarning = false; }
                else if (isWarning) { badgeClass += ' warning'; }
                omitHTML = `<span class="${badgeClass}">Omit: ${missing.join(', ')}</span>`;
            }

            let ctrl = `<div class="h-6 w-full"></div>`;
            if (patterns.length > 1) {
                 ctrl = `<div class="flex items-center w-full mb-1 bg-[#1a1a1a] rounded border border-[#333]"><button onclick="chgStd('${key}',-1)" class="flex-1 text-gray-400 text-xs py-1">‚óÄ</button><span class="text-xs text-gray-400 font-mono">Ver ${idx%patterns.length+1}/${patterns.length}</span><button onclick="chgStd('${key}',1)" class="flex-1 text-gray-400 text-xs py-1">‚ñ∂</button></div>`;
            }
            
            let btns = '';
            if(data.slash.length) {
                btns += `<div class="mt-2 flex flex-wrap gap-1 justify-center">`;
                btns += `<button onclick="selB('${key}','std')" class="bass-btn std-sel-btn ${sel==='std'?'active':''}">Standard</button>`;
                let seen = new Set();
                data.slash.forEach(s => { 
                    if(!seen.has(s.bass)) { 
                        seen.add(s.bass); 
                        btns += `<button onclick="selB('${key}','${s.bass}')" class="bass-btn ${sel===s.bass?'active':''}">/${s.bass}</button>`; 
                    } 
                });
                btns += `</div>`;
            }

            const uid = key.replace('#','s'); 
            const svg = drawBoard(parseFrets(pat.f), rootObj.val, typeId, uid, pat.flags);

            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-bold text-white flex gap-2 items-center flex-wrap">${title}${omitHTML}<button class="play-btn" onclick="playChord('${pat.f}')">üîä</button></h2>
                    <div class="w-24">${ctrl}</div>
                </div>
                <div class="w-full overflow-x-auto fretboard-scroll" id="fb-${uid}">${svg}</div>
                ${btns}
            `;

            setTimeout(() => {
                const el = document.getElementById(`fb-${uid}`);
                if(el) {
                    const fr = parseFrets(pat.f).filter(x=>x>0);
                    let centerFretVal = 1;
                    if(fr.length > 0) {
                        centerFretVal = (Math.min(...fr) + Math.max(...fr)) / 2;
                    }
                    
                    const centerX = 40 + centerFretVal * 45 - 22.5;
                    
                    el.scrollTo({
                        left: centerX - el.clientWidth / 2,
                        behavior: 'auto'
                    });
                }
            }, 50); 
        }

        generateAll();
        render();
        updModeBtns();

        function updModeBtns() {
            document.getElementById('btn-note').className = `px-3 py-1 rounded text-[10px] font-bold transition-all ${state.displayMode==='note'?'bg-blue-600 text-white shadow':'text-gray-400 hover:text-white'}`;
            document.getElementById('btn-degree').className = `px-3 py-1 rounded text-[10px] font-bold transition-all ${state.displayMode==='degree'?'bg-blue-600 text-white shadow':'text-gray-400 hover:text-white'}`;
        }
    </script>
</body>
</html>

